version: "3.8"
services:
  mysqldb:
    image: mysql:8
    container_name: mysqldb
    environment:
      MYSQL_ROOT_PASSWORD: education
      MYSQL_DATABASE: guestbook
      # 1. ë‹¤ë¥¸ ì»¨í…Œì´ë„ˆ(ì•±)ì˜ ì ‘ì†ì„ í—ˆìš©í•©ë‹ˆë‹¤.
      MYSQL_ROOT_HOST: "%"
    
    # 2. MySQL 8.0ê³¼ JDBCì˜ í˜¸í™˜ì„± ë¬¸ì œë¥¼ í•´ê²°í•©ë‹ˆë‹¤.
    command: --default-authentication-plugin=mysql_native_password
    
    ports:
      # í˜¸ìŠ¤íŠ¸ PCì—ì„œ ì ‘ê·¼í•  í¬íŠ¸: ì»¨í…Œì´ë„ˆ ë‚´ë¶€ í¬íŠ¸
      - "3310:3306" 
    volumes:
      - mysql_data:/var/lib/mysql
    networks:
      - guestbook_network
      
    # 3. DBê°€ ì™„ì „íˆ ì¤€ë¹„ë  ë•Œê¹Œì§€ ì•±ì´ ê¸°ë‹¤ë¦¬ë„ë¡ í—¬ìŠ¤ì²´í¬ë¥¼ ì¶”ê°€í•©ë‹ˆë‹¤.
    healthcheck:
      test: ["CMD", "mysqladmin" ,"ping", "-h", "localhost", "-u", "root", "-p$$MYSQL_ROOT_PASSWORD"]
      interval: 10s
      timeout: 5s
      retries: 5

  guestbook-app:
    image: dstle/guestbook-app:latest Â 
    container_name: guestbook-app
    ports:
      # EC2ì—ì„œ ì•±ì´ ì™¸ë¶€ì— ë…¸ì¶œë˜ëŠ” í¬íŠ¸: ì»¨í…Œì´ë„ˆ ë‚´ë¶€ í†°ìº£ í¬íŠ¸
      - "8888:8080" 
    environment:
      # ğŸš¨ ì—¬ê¸°ì„œ í™˜ê²½ ë³€ìˆ˜ë¥¼ ì£¼ì…í•˜ì—¬ application.ymlì˜ ë‚´ìš©ì„ ë®ì–´ì”ë‹ˆë‹¤.
      # ì»¨í…Œì´ë„ˆ ê°„ í†µì‹ ì€ 'ì„œë¹„ìŠ¤ ì´ë¦„(mysqldb)'ê³¼ 'ë‚´ë¶€ í¬íŠ¸(3306)'ë¥¼ ì‚¬ìš©í•´ì•¼ í•©ë‹ˆë‹¤.
      SPRING_DATASOURCE_URL: "jdbc:mysql://mysqldb:3306/guestbook?useSSL=false&allowPublicKeyRetrieval=true&serverTimezone=UTC"
      SPRING_DATASOURCE_USERNAME: root
      SPRING_DATASOURCE_PASSWORD: education
      SPRING_JPA_HIBERNATE_DDL_AUTO: update
      SPRING_JPA_SHOW_SQL: "true"
      SPRING_JPA_PROPERTIES_HIBERNATE_DIALECT: "org.hibernate.dialect.MySQL8Dialect"
      SERVER_PORT: "8080" # ë‚´ë¶€ í¬íŠ¸ë¥¼ 8080ìœ¼ë¡œ ê°•ì œ ì§€ì •
      
    depends_on:
      mysqldb:
        condition: service_healthy # DBê°€ healthcheckë¥¼ í†µê³¼í•  ë•Œê¹Œì§€ ê¸°ë‹¤ë¦½ë‹ˆë‹¤.
    
    networks:
      - guestbook_network

volumes:
  mysql_data:

networks:
  guestbook_network:
    driver: bridge